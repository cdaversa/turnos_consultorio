<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Profesional</title>
<style>
    body.fondo-dientes {
        background: url('/static/fondo_dientes4.jpg') repeat center center;
        background-size: auto;
        font-family: Arial, sans-serif;
        color: #333;
        margin: 0;
        padding: 0;
        text-align: center;
        position: relative;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th, td {
        padding: 10px;
        border: 1px solid #ccc;
        text-align: center;
    }

    th { background: #007BFF; color: white; }

    tr.en-sala { background: #FFD580; }
    tr.reservado { background: #E8F6F3; }
    tr.atendido { background: #C6F6C6; }
    tr.libre { background: #ffffff; color: #999; font-style: italic; }

    button {
        padding: 5px 10px;
        background: #28a745;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }

    button:hover { background: #218838; }

    .logout-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
    }

    .logout-btn:hover { background: #b52b37; }

    /* âœ… Contenedor del filtro (igual que admin) */
    .filtro-container {
        width: 100%;
        padding: 0 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        flex-wrap: nowrap;
    }

    .filtro-container label {
        font-weight: bold;
        white-space: nowrap;
    }

    /* âœ… Input de fecha agrandado */
    #selector-fecha {
        height: 45px;
        font-size: 16px;
        padding: 5px;
        min-width: 180px;
        max-width: 220px;
        flex-shrink: 0;
    }

    /* âœ… Botones estilo admin */
    .btn-estilo {
        height: 45px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 20px;
        flex-shrink: 0;
    }

    .btn-hoy {
        background: #28a745;
        color: white;
        font-weight: bold;
    }

    .btn-hoy:hover { background: #1e7e34; }

    /* âœ… RESPONSIVE para mÃ³viles */
    @media (max-width: 768px) {
        .filtro-container { flex-wrap: wrap; gap: 8px; }
        #selector-fecha { width: 100%; max-width: 250px; }
        .btn-estilo, .btn-hoy { width: 100%; max-width: 250px; }
        .logout-btn { position: static; display: block; margin: 10px auto; }
    }
</style>
</head>
<body class="fondo-dientes">

<h1>Turnos del DÃ­a <span id="fecha-mostrar">{{ fecha }}</span></h1>

<div class="filtro-container">
    <label for="selector-fecha">Filtrar por fecha:</label>
    <input type="date" id="selector-fecha" value="{{ fecha }}" onchange="cargarTurnos()">
    <button class="btn-estilo btn-hoy" onclick="irAHoy()">Ir a Hoy</button>
</div>

<table id="tabla-turnos">
    <thead>
        <tr><th>Hora</th><th>Nombre</th><th>DNI</th><th>TelÃ©fono</th><th>Estado</th><th>AcciÃ³n</th></tr>
    </thead>
    <tbody></tbody>
</table>
<a href="{{ url_for('logout_profesional') }}" class="logout-btn">ðŸšª Cerrar SesiÃ³n</a>


<script>
function cargarTurnos() {
    const fecha = document.getElementById("selector-fecha").value || "{{ fecha }}";
    document.getElementById("fecha-mostrar").innerText = fecha;

    fetch(`/api/turnos_dia?fecha=${fecha}`)
    .then(res => res.json())
    .then(turnos => {
        const tbody = document.querySelector("#tabla-turnos tbody");
        tbody.innerHTML = "";
        turnos.forEach(t => {
            const tr = document.createElement("tr");
            tr.className = t.estado === "en_sala" ? "en-sala" :
                           t.estado === "atendido" ? "atendido" :
                           t.estado === "reservado" ? "reservado" : "libre";

            // âœ… Solo permitir botÃ³n si estÃ¡ "en_sala"
            let acciones = "";
            if (t.estado === "en_sala") {
                acciones = `<button onclick="marcarAtendido('${t.dni}','${t.fecha}','${t.hora}', this)">âœ… Marcar Atendido</button>`;
            }

            tr.innerHTML = `
                <td>${t.hora}</td>
                <td>${t.nombre || '(Libre)'}</td>
                <td>${t.dni || '-'}</td>
                <td>${t.telefono || '-'}</td>
                <td>${t.estado === "libre" ? "âšª Libre" :
                    (t.estado === "en_sala" ? "ðŸŸ¢ En Sala" :
                    (t.estado === "atendido" ? "âœ… Atendido" : "ðŸ”µ Reservado"))}</td>
                <td>${acciones}</td>`;
            tbody.appendChild(tr);
        });
    });
}

function marcarAtendido(dni, fecha, hora, btn) {
    const fila = btn.closest("tr");
    fila.className = "atendido";
    fila.children[4].textContent = "âœ… Atendido";
    fila.children[5].innerHTML = "";
    localStorage.setItem("estadoTurnoActualizado", Date.now());

    fetch('/marcar_atendido', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `dni=${dni}&fecha=${fecha}&hora=${hora}`
    }).catch(() => cargarTurnos());
}

function irAHoy() {
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById("selector-fecha").value = hoy;
    cargarTurnos();
}

document.addEventListener("DOMContentLoaded", cargarTurnos);
setInterval(cargarTurnos, 5000);
</script>
</body>
</html>
